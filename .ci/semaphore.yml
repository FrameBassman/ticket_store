# .ci/semaphore.yml
version: v1.0
name: Deployment to staging pipeline
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
blocks:
  - name: Deploy to staging on heroku
    task:
      secrets:
        - name: Heroku
        - name: private-repo
      env_vars:
        - name: DOTNET_SKIP_FIRST_TIME_EXPERIENCE
          value: "1"
        - name: DOTNET_CLI_TELEMETRY_OPTOUT
          value: "1"
        - name: ASPNETCORE_ENVIRONMENT
          value: "Staging"
      jobs:
        - name: Build and deploy
          commands:
              # Install heroku
            - curl https://cli-assets.heroku.com/install.sh | sh
            - heroku --version
              # Install dotnet core sdk
            - wget https://packages.microsoft.com/config/ubuntu/19.10/packages-microsoft-prod.deb -O packages-microsoft-prod.deb
            - sudo dpkg -i packages-microsoft-prod.deb
            - sudo apt-get update
            - sudo apt-get install apt-transport-https
            - sudo apt-get update
            - sudo apt-get install -y dotnet-sdk-3.1
              # Setup ssh and checkout
            - chmod 0600 ~/.ssh/*
            - checkout
            - cd Services
            - heroku container:login
            - heroku container:push web --app staging-chertopolokh
            - heroku container:release web --app staging-chertopolokh
              # Migrate staging database
            - cd ..
            - export DATABASE_URL=$(heroku config:get DATABASE_URL --app staging-chertopolokh)
            - dotnet tool install --global dotnet-ef --version 3.1.3
            - ~/.dotnet/tools/dotnet-ef database update --project Services/TicketStore.Data/TicketStore.Data.csproj --verbose
